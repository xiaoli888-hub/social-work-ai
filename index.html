<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹ (Groq é«˜çº§ç‰ˆ)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f5f7; color: #333;}
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px;}
    button.primary-btn { padding: 14px 20px; font-size: 16px; font-weight: bold; margin-top: 15px; border-radius: 8px; border: none; cursor: pointer; width: 100%; transition: 0.2s; color: white;}
    #startBtn { background-color: #07c160; }
    #stopBtn { background-color: #fa5151; display: none; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #status { text-align: center; margin: 15px 0; font-size: 14px; color: #888; font-weight: bold;}
    #timer { font-size: 18px; color: #fa5151; font-weight: bold; margin-left: 5px;}
    
    #reportCard { display: none; padding-bottom: 10px; }
    #result { margin-top: 10px; white-space: pre-wrap; font-size: 15px; line-height: 1.8; color: #222; }
    
    .report-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
    .word-count { color: #999; font-size: 14px; }
    .copy-btn { padding: 8px 16px; font-size: 14px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; color: #555; cursor: pointer; transition: 0.2s;}
    .copy-btn:hover { background-color: #e4e4e4; }
  </style>
</head>
<body>

  <h2 style="text-align: center;">ğŸ¤ AI ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹ (Proç‰ˆ)</h2>

  <div class="card">
    <label style="font-size: 14px; font-weight: bold;">ğŸ”‘ æ™ºè°± API Key (ç”¨äºæ’ç‰ˆæ•´ç†):</label>
    <input type="password" id="zhipuApiKey" placeholder="è¾“å…¥æ™ºè°± API Key">
    
    <label style="font-size: 14px; font-weight: bold; display: block; margin-top: 15px;">ğŸ”‘ Groq API Key (ç”¨äºè¶…å¼ºè¯­éŸ³è½¬å­—):</label>
    <input type="password" id="groqApiKey" placeholder="è¾“å…¥ Groq API Key (gsk_å¼€å¤´)">
    
    <label style="font-size: 14px; font-weight: bold; display: block; margin-top: 15px;">ğŸ—£ï¸ å¼•å¯¼æ¨¡å‹è¯†åˆ«è¯­è¨€ (æ–¹è¨€ä¹Ÿé€‰ä¸­æ–‡):</label>
    <select id="langSelect">
      <option value="zh">ä¸­æ–‡ (åŒ…å«æ™®é€šè¯åŠå„åœ°æ–¹è¨€)</option>
      <option value="en">è‹±æ–‡</option>
    </select>
  </div>

  <div class="card">
    <button id="startBtn" class="primary-btn">â–¶ï¸ å¼€å§‹å½•éŸ³è®¿è°ˆ</button>
    <button id="stopBtn" class="primary-btn">â¹ï¸ ç»“æŸå½•éŸ³å¹¶å¼€å§‹ AI å¤„ç†</button>
    
    <div id="status">å‡†å¤‡å°±ç»ª...</div>
    
    <label style="font-size: 14px; font-weight: bold;">ğŸ“ ç²¾å‡†è¯­éŸ³è½¬å†™ç»“æœ (æ”¯æŒæ–¹è¨€):</label>
    <textarea id="transcript" rows="6" placeholder="å½•éŸ³ç»“æŸåï¼ŒWhisper å¤§æ¨¡å‹è¯†åˆ«çš„æ–‡å­—ä¼šå‡ºç°åœ¨è¿™é‡Œ..."></textarea>
  </div>

  <div class="card" id="reportCard">
    <h3 style="margin-top: 0; text-align: center; color: #07c160;">ğŸ“‘ ç¤¾å·¥è®¿è°ˆæ•´ç†è®°å½•</h3>
    <div id="result"></div>
    
    <div class="report-footer">
      <span class="word-count" id="wordCount">0 å­—</span>
      <button class="copy-btn" id="copyBtn">å¤åˆ¶å…¨æ–‡</button>
    </div>
  </div>

  <script>
    // 1. åˆå§‹åŒ–å¹¶ä¿å­˜ä¸¤ä¸ª API Key
    const zhipuApiKeyInput = document.getElementById('zhipuApiKey');
    const groqApiKeyInput = document.getElementById('groqApiKey');
    
    zhipuApiKeyInput.value = localStorage.getItem('zhipu_api_key') || '';
    groqApiKeyInput.value = localStorage.getItem('groq_api_key') || '';
    
    zhipuApiKeyInput.addEventListener('input', function() { localStorage.setItem('zhipu_api_key', this.value); });
    groqApiKeyInput.addEventListener('input', function() { localStorage.setItem('groq_api_key', this.value); });

    // 2. å½•éŸ³å¼•æ“ç›¸å…³å˜é‡
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let secondsRecorded = 0;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const transcriptArea = document.getElementById('transcript');
    const reportCard = document.getElementById('reportCard');
    const resultDiv = document.getElementById('result');
    const langSelect = document.getElementById('langSelect');
    const wordCountSpan = document.getElementById('wordCount');
    const copyBtn = document.getElementById('copyBtn');

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º (ä¾‹å¦‚ 01:05)
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // 3. ç‚¹å‡»å¼€å§‹å½•éŸ³
    startBtn.onclick = async () => {
      if (!zhipuApiKeyInput.value.trim() || !groqApiKeyInput.value.trim()) {
        alert("è¯·å…ˆå¡«å†™é¡¶éƒ¨çš„ä¸¤ä¸ª API Keyï¼");
        return;
      }

      try {
        // è¯·æ±‚éº¦å…‹é£æƒé™
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        
        // åˆå§‹åŒ–å½•éŸ³æœº
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = []; // æ¸…ç©ºä¹‹å‰çš„éŸ³é¢‘ç¢ç‰‡

        // æ”¶é›†éŸ³é¢‘æ•°æ®
        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) audioChunks.push(event.data);
        };

        // å½•éŸ³ç»“æŸæ—¶çš„æ ¸å¿ƒé€»è¾‘ï¼
        mediaRecorder.onstop = async () => {
          // é‡Šæ”¾éº¦å…‹é£
          stream.getTracks().forEach(track => track.stop());
          
          // å°†æ”¶é›†åˆ°çš„ç¢ç‰‡æ‰“åŒ…æˆä¸€ä¸ªå®Œæ•´çš„ WebM éŸ³é¢‘æ–‡ä»¶
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          
          if (audioChunks.length === 0) {
              statusDiv.innerHTML = "âŒ å½•éŸ³å¤±è´¥ï¼Œæ²¡æœ‰æ•æ‰åˆ°å£°éŸ³ã€‚";
              return;
          }

          // å¼€å¯å…¨è‡ªåŠ¨åŒæ¨¡å‹å¤„ç†æµæ°´çº¿
          await processAudioAndText(audioBlob);
        };

        // æ­£å¼å¼€å§‹å½•åˆ¶
        mediaRecorder.start(1000); // æ¯ç§’åå‡ºä¸€ä¸ªæ•°æ®å—
        
        // ç•Œé¢æ›´æ–°ä¸è®¡æ—¶å™¨
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        transcriptArea.value = '';
        reportCard.style.display = 'none';
        
        secondsRecorded = 0;
        statusDiv.innerHTML = `ğŸ”´ æ­£åœ¨å½•éŸ³ä¸­ <span id="timer">00:00</span>`;
        recordingTimer = setInterval(() => {
          secondsRecorded++;
          document.getElementById('timer').innerText = formatTime(secondsRecorded);
        }, 1000);

      } catch (err) {
        console.error("éº¦å…‹é£å¯åŠ¨å¤±è´¥:", err);
        alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨å·²æˆäºˆæµè§ˆå™¨éº¦å…‹é£æƒé™ï¼\né”™è¯¯è¯¦æƒ…: " + err.message);
      }
    };

    // 4. ç‚¹å‡»ç»“æŸå½•éŸ³
    stopBtn.onclick = () => {
      clearInterval(recordingTimer);
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      statusDiv.innerHTML = "â³ å½•éŸ³å·²ç»“æŸï¼Œæ­£åœ¨æ‰“åŒ…éŸ³é¢‘...";
      
      // è¿™ä¼šè§¦å‘ mediaRecorder.onstop äº‹ä»¶
      mediaRecorder.stop(); 
    };

    // 5. æ ¸å¿ƒå¤§æ¨¡å‹æµæ°´çº¿ï¼šå…ˆè°ƒ Groq (è¯­éŸ³è½¬æ–‡å­—) -> å†è°ƒ æ™ºè°± (æ–‡å­—æ’ç‰ˆ)
    async function processAudioAndText(audioBlob) {
      const groqKey = groqApiKeyInput.value.trim();
      const zhipuKey = zhipuApiKeyInput.value.trim();
      
      try {
        // ========== é˜¶æ®µä¸€ï¼šè°ƒç”¨ Groq Whisper å¤§æ¨¡å‹è¿›è¡Œè¯­éŸ³è¯†åˆ« ==========
        statusDiv.innerHTML = "â³ [1/2] æ­£åœ¨å‘é€è‡³ Groq Whisper å¤§æ¨¡å‹è¯†åˆ«è¯­éŸ³...";
        
        const formData = new FormData();
        // ç»™ Blob éšä¾¿èµ·ä¸ªåå­—ï¼ŒGroq ä¼šè‡ªåŠ¨è¯†åˆ«æ ¼å¼
        formData.append('file', audioBlob, 'recording.webm'); 
        formData.append('model', 'whisper-large-v3');
        formData.append('language', langSelect.value); // å¼ºåˆ¶è¾“å‡ºä¸­æ–‡
        // formData.append('prompt', 'è¿™æ˜¯ä¸€æ®µç¤¾å·¥è®¿è°ˆè®°å½•ï¼ŒåŒ…å«æ™®é€šè¯å’Œæ–¹è¨€ã€‚'); // å¯é€‰ï¼šæ·»åŠ æç¤ºè¯å¸®åŠ©æ¨¡å‹ç†è§£ä¸Šä¸‹æ–‡

        const groqResponse = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${groqKey}` },
          body: formData
        });

        const groqData = await groqResponse.json();
        
        if (!groqResponse.ok) {
            throw new Error(`Groq è¯­éŸ³è¯†åˆ«å¤±è´¥: ${groqData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        }

        const transcriptText = groqData.text.trim();
        transcriptArea.value = transcriptText;

        if (!transcriptText) {
             statusDiv.innerHTML = "âš ï¸ å½•éŸ³å¤ªçŸ­æˆ–å…¨æ˜¯é™éŸ³ï¼Œæ¨¡å‹æœªè¯†åˆ«å‡ºæ–‡å­—ã€‚";
             return;
        }

        // ========== é˜¶æ®µäºŒï¼šè°ƒç”¨ æ™ºè°± AI å¤§æ¨¡å‹è¿›è¡Œæ•´ç†æ’ç‰ˆ ==========
        statusDiv.innerHTML = "â³ [2/2] è¯­éŸ³è¯†åˆ«å®Œæˆï¼æ­£åœ¨äº¤ç»™æ™ºè°± AI æ•´ç†æ’ç‰ˆ...";
        reportCard.style.display = 'block';
        resultDiv.innerText = "æ·±å…¥åˆ†æä¸­...";

        const zhipuResponse = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${zhipuKey}`
          },
          body: JSON.stringify({
            model: "glm-4-flash-250414",
            messages: [
              {
                role: "system",
                content: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾ä¼šå·¥ä½œæ¡ˆä¾‹è®°å½•å‘˜ã€‚è¯·æ ¹æ®æä¾›çš„è®¿è°ˆè¯­éŸ³è½¬å½•æ–‡æœ¬ï¼Œå°†å†…å®¹æ•´ç†å½’ç±»ä¸ºä»¥ä¸‹å››ä¸ªç»´åº¦ï¼š

ã€å®¶åº­æƒ…å†µã€‘
ï¼ˆå®¶åº­æˆå‘˜æ„æˆã€å®¶åº­å…³ç³»ã€å©šå§»çŠ¶å†µã€å­å¥³æƒ…å†µã€å®¶åº­æ”¯æŒç­‰ï¼‰

ã€èº«ä½“çŠ¶å†µã€‘
ï¼ˆå¥åº·çŠ¶å†µã€ç–¾ç—…å²ã€æ®‹ç–¾æƒ…å†µã€å°±åŒ»æƒ…å†µã€æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›ç­‰ï¼‰

ã€ç»æµçŠ¶å†µã€‘
ï¼ˆæ”¶å…¥æ¥æºã€å°±ä¸šæƒ…å†µã€ä½ä¿/è¡¥è´´ã€å€ºåŠ¡æƒ…å†µã€æ¶ˆè´¹æ”¯å‡ºç­‰ï¼‰

ã€å…¶ä»–æƒ…å†µã€‘
ï¼ˆå±…ä½æƒ…å†µã€ç¤¾ä¼šæ”¯æŒç½‘ç»œã€å¿ƒç†çŠ¶æ€ã€ç‰¹æ®Šéœ€æ±‚ã€æœåŠ¡æ„æ„¿ã€æœåŠ¡éœ€æ±‚ã€å…¶ä»–é‡è¦ä¿¡æ¯ç­‰ï¼Œå¦‚æœæ²¡æœ‰æœåŠ¡éœ€æ±‚æˆ–æ„æ„¿ï¼Œè¯·æ³¨æ˜æš‚æ—¶æ²¡æœ‰æœåŠ¡éœ€æ±‚ï¼‰

è¦æ±‚ï¼šè¯­è¨€ç®€æ´å®¢è§‚ï¼Œä½¿ç”¨ç¤¾å·¥ä¸“ä¸šæœ¯è¯­ï¼›ä¸æ·»åŠ ä¸»è§‚åˆ¤æ–­ã€‚`
              },
              { role: "user", content: transcriptText }
            ],
            temperature: 0.1
          })
        });

        const zhipuData = await zhipuResponse.json();
        
        if (zhipuResponse.ok) {
           let aiReply = zhipuData.choices[0].message.content.trim();
           resultDiv.innerText = aiReply;
           statusDiv.innerHTML = "âœ… <span style='color: #07c160;'>å…¨æµç¨‹å¤„ç†å®Œæ¯•ï¼ä½ å¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶ã€‚</span>";
           
           const textLength = aiReply.replace(/\s+/g, '').length;
           wordCountSpan.innerText = textLength + " å­—";
        } else {
           throw new Error(`æ™ºè°± AI åˆ†æå¤±è´¥: ${JSON.stringify(zhipuData.error)}`);
        }

      } catch (error) {
        console.error("æµæ°´çº¿å¤„ç†å‡ºé”™:", error);
        statusDiv.innerHTML = `<span style="color:red;">âŒ å¤„ç†å¤±è´¥: ${error.message}</span>`;
      }
    }

    // 6. å¤åˆ¶å…¨æ–‡åŠŸèƒ½
    copyBtn.onclick = () => {
      const textToCopy = resultDiv.innerText;
      if (!textToCopy) return;

      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = copyBtn.innerText;
        copyBtn.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
        copyBtn.style.backgroundColor = "#e6f7eb";
        copyBtn.style.color = "#07c160";
        copyBtn.style.borderColor = "#07c160";
        
        setTimeout(() => {
          copyBtn.innerText = originalText;
          copyBtn.style.backgroundColor = "#f0f0f0";
          copyBtn.style.color = "#555";
          copyBtn.style.borderColor = "#ddd";
        }, 2000);
      }).catch(err => {
        alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰æ–‡å­—é€‰æ‹©å¤åˆ¶ã€‚");
      });
    };
  </script>

</body>
</html>

