<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹ (ä¿®å¤ç‰ˆ)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f5f7; color: #333;}
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px;}
    button.primary-btn { padding: 14px 20px; font-size: 16px; font-weight: bold; margin-top: 15px; border-radius: 8px; border: none; cursor: pointer; width: 100%; transition: 0.2s; color: white;}
    #startBtn { background-color: #07c160; }
    #stopBtn { background-color: #fa5151; display: none; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #status { text-align: center; margin: 15px 0; font-size: 14px; color: #888; }
    
    /* æŠ¥å‘Šå±•ç¤ºåŒºåŸŸæ ·å¼ */
    #reportCard { display: none; padding-bottom: 10px; }
    #result { margin-top: 10px; white-space: pre-wrap; font-size: 15px; line-height: 1.8; color: #222; }
    
    /* åº•éƒ¨å·¥å…·æ æ ·å¼ */
    .report-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
    .word-count { color: #999; font-size: 14px; }
    .copy-btn { padding: 8px 16px; font-size: 14px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; color: #555; cursor: pointer; transition: 0.2s;}
    .copy-btn:hover { background-color: #e4e4e4; }

    .pulse { animation: pulse-animation 1.5s infinite; color: #fa5151; font-weight: bold;}
    @keyframes pulse-animation { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body>

  <h2 style="text-align: center;">ğŸ¤ AI ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹</h2>

  <div class="card">
    <label for="apiKey" style="font-size: 14px; font-weight: bold;">ğŸ”‘ æ™ºè°± API Key (æœ¬åœ°å®‰å…¨å­˜å‚¨):</label>
    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API Key">
    
    <label for="langSelect" style="font-size: 14px; font-weight: bold; display: block; margin-top: 15px;">ğŸ—£ï¸ é€‰æ‹©å—è®¿è€…è¯­è¨€:</label>
    <select id="langSelect">
      <option value="zh-CN">æ™®é€šè¯</option>
      <option value="zh-HK">ç²¤è¯­ (å¹¿ä¸œè¯)</option>
    </select>
  </div>

  <div class="card">
    <button id="startBtn" class="primary-btn">â–¶ï¸ å¼€å§‹è®¿è°ˆ (å½•éŸ³å¹¶è½¬æ–‡å­—)</button>
    <button id="stopBtn" class="primary-btn">â¹ï¸ ç»“æŸè®¿è°ˆ (äº¤ç”± AI æ•´ç†)</button>
    
    <div id="status">å‡†å¤‡å°±ç»ª...</div>
    
    <label style="font-size: 14px; font-weight: bold;">ğŸ“ å®æ—¶è®¿è°ˆè®°å½• (å¯æ‰‹åŠ¨ä¿®æ”¹è¡¥å……):</label>
    <textarea id="transcript" rows="6" placeholder="å½“ä½ å¼€å§‹è¯´è¯æ—¶ï¼Œæ–‡å­—ä¼šå®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
  </div>

  <div class="card" id="reportCard">
    <h3 style="margin-top: 0; text-align: center; color: #07c160;">ğŸ“‘ ç¤¾å·¥è®¿è°ˆæ•´ç†è®°å½•</h3>
    <div id="result"></div>
    
    <div class="report-footer">
      <span class="word-count" id="wordCount">0 å­—</span>
      <button class="copy-btn" id="copyBtn">å¤åˆ¶å…¨æ–‡</button>
    </div>
  </div>

  <script>
    // 1. åˆå§‹åŒ– API Key
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.value = localStorage.getItem('zhipu_api_key') || '';
    apiKeyInput.addEventListener('input', function() {
      localStorage.setItem('zhipu_api_key', this.value);
    });

    // 2. åˆå§‹åŒ–æµè§ˆå™¨è¯­éŸ³è¯†åˆ« API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isRecording = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const transcriptArea = document.getElementById('transcript');
    const reportCard = document.getElementById('reportCard');
    const resultDiv = document.getElementById('result');
    const langSelect = document.getElementById('langSelect');
    const wordCountSpan = document.getElementById('wordCount');
    const copyBtn = document.getElementById('copyBtn');

    if (!SpeechRecognition) {
      statusDiv.innerHTML = "âŒ ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chromeã€Edge æˆ– Safari æµè§ˆå™¨ã€‚";
      startBtn.disabled = true;
    } else {
      recognition = new SpeechRecognition();
      recognition.continuous = true; 
      recognition.interimResults = true; 

      recognition.onend = () => {
        if (isRecording) {
          try { recognition.start(); } catch(e) { }
        }
      };

      // ã€æ ¸å¿ƒä¿®å¤åŒºã€‘ï¼šä¸“é—¨æ•æ‰æµè§ˆå™¨çš„åº•å±‚ç½‘ç»œå’Œéº¦å…‹é£é”™è¯¯ï¼Œå¹¶å¼¹çª—æŠ¥è­¦ï¼
      recognition.onerror = (event) => {
        console.error("è¯­éŸ³è¯†åˆ«åº•å±‚æŠ¥é”™:", event.error);
        isRecording = false;
        
        // æ¢å¤æŒ‰é’®çŠ¶æ€
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        langSelect.disabled = false;
        
        let errorMsg = event.error;
        if (event.error === 'not-allowed') {
           errorMsg = "éº¦å…‹é£æƒé™è¢«æ‹’ç»ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨è®¾ç½®ã€‚";
        } else if (event.error === 'network') {
           errorMsg = "ç½‘ç»œè¿æ¥å¤±è´¥ï¼(å¦‚æœä½ åœ¨ä½¿ç”¨ Chromeï¼Œå¤§æ¦‚ç‡æ˜¯è¢«å¢™æ‹¦æˆªäº†ï¼Œè¯·æ¢ç”¨ Edge æµè§ˆå™¨é‡è¯•)";
        } else if (event.error === 'no-speech') {
           errorMsg = "é•¿æ—¶é—´æœªæ£€æµ‹åˆ°å£°éŸ³ï¼Œè¯†åˆ«å·²è‡ªåŠ¨æš‚åœã€‚";
        }

        statusDiv.innerHTML = `<span style="color:red;">âŒ å‘ç”Ÿé”™è¯¯: ${errorMsg}</span>`;
        // å¼ºåˆ¶å¼¹çª—ï¼Œè®©ä½ ç»å¯¹èƒ½çœ‹åˆ°æŠ¥é”™
        alert("è¯­éŸ³è¯†åˆ«æ¨¡å—å‡ºé”™ï¼š\n" + errorMsg);
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        
        if (finalTranscript) {
           transcriptArea.value += finalTranscript + "ã€‚";
        }
        statusDiv.innerHTML = `<span class="pulse">ğŸ”´ æ­£åœ¨è†å¬...</span> ` + interimTranscript;
      };
    }

    // 3. ç‚¹å‡»å¼€å§‹è®¿è°ˆ
    startBtn.onclick = () => {
      if (!apiKeyInput.value.trim()) {
        alert("è¯·å…ˆå¡«å†™é¡¶éƒ¨çš„ API Keyï¼");
        return;
      }

      // å…ˆæ”¹å˜ç•Œé¢ï¼Œå†å¯åŠ¨å½•éŸ³ï¼ˆé˜²æ­¢é™é»˜å¡æ­»ï¼‰
      startBtn.style.display = 'none';
      stopBtn.style.display = 'block';
      statusDiv.innerHTML = `<span class="pulse">ğŸ”´ æ­£åœ¨è¯·æ±‚å¯åŠ¨éº¦å…‹é£...</span>`;
      langSelect.disabled = true;
      transcriptArea.value = ''; 
      reportCard.style.display = 'none';
      resultDiv.innerText = '';
      wordCountSpan.innerText = '0 å­—';
      
      try {
        recognition.lang = langSelect.value;
        recognition.start();
        isRecording = true;
        statusDiv.innerHTML = `<span class="pulse">ğŸ”´ æ­£åœ¨è†å¬ (${langSelect.options[langSelect.selectedIndex].text})...</span>`;
      } catch (e) {
        console.error("å°è¯•å¯åŠ¨å½•éŸ³å¤±è´¥:", e);
        startBtn.style.display = 'block';
        stopBtn.style.display = 'none';
        langSelect.disabled = false;
        statusDiv.innerHTML = "âŒ å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥éº¦å…‹é£ã€‚";
        alert("å°è¯•å¯åŠ¨éº¦å…‹é£å¤±è´¥ï¼š" + e.message);
      }
    };

    // 4. ç‚¹å‡»ç»“æŸè®¿è°ˆ
    stopBtn.onclick = async () => {
      isRecording = false;
      recognition.stop();
      
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      langSelect.disabled = false; 
      
      const textToProcess = transcriptArea.value.trim();
      if (!textToProcess) {
        statusDiv.innerText = "âš ï¸ æ²¡æœ‰å½•å…¥ä»»ä½•å†…å®¹ï¼Œåˆ†æå–æ¶ˆã€‚";
        return;
      }

      statusDiv.innerText = "â³ è®¿è°ˆç»“æŸã€‚AI æ­£åœ¨ç”Ÿæˆä¸“ä¸šæ’ç‰ˆæŠ¥å‘Šï¼Œè¯·ç¨å€™...";
      reportCard.style.display = 'block';
      resultDiv.innerText = "æ·±å…¥åˆ†æä¸­...";

      await callLLM(textToProcess);
    };

    // 5. å¤åˆ¶å…¨æ–‡åŠŸèƒ½
    copyBtn.onclick = () => {
      const textToCopy = resultDiv.innerText;
      if (!textToCopy) return;

      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = copyBtn.innerText;
        copyBtn.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
        copyBtn.style.backgroundColor = "#e6f7eb";
        copyBtn.style.color = "#07c160";
        copyBtn.style.borderColor = "#07c160";
        
        setTimeout(() => {
          copyBtn.innerText = originalText;
          copyBtn.style.backgroundColor = "#f0f0f0";
          copyBtn.style.color = "#555";
          copyBtn.style.borderColor = "#ddd";
        }, 2000);
      }).catch(err => {
        alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰æ–‡å­—é€‰æ‹©å¤åˆ¶ã€‚");
      });
    };

    // 6. è°ƒç”¨å¤§æ¨¡å‹åˆ†æä»£ç 
    async function callLLM(text) {
      const apiKey = apiKeyInput.value.trim();
      try {
        const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "glm-4-flash-250414",
            messages: [
              {
                role: "system",
                content: `ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„ç¤¾ä¼šå·¥ä½œæ¡ˆä¾‹è®°å½•å‘˜ã€‚è¯·æ ¹æ®æä¾›çš„è®¿è°ˆè¯­éŸ³è½¬å½•æ–‡æœ¬ï¼Œå°†å†…å®¹æ•´ç†å½’ç±»ä¸ºä»¥ä¸‹å››ä¸ªç»´åº¦ï¼š

ã€å®¶åº­æƒ…å†µã€‘
ï¼ˆå®¶åº­æˆå‘˜æ„æˆã€å±…ä½æƒ…å†µã€å®¶åº­å…³ç³»ã€å©šå§»çŠ¶å†µã€å­å¥³æƒ…å†µã€å®¶åº­æ”¯æŒç­‰ï¼‰

ã€èº«ä½“çŠ¶å†µã€‘
ï¼ˆå¥åº·çŠ¶å†µã€ç–¾ç—…å²ã€æ®‹ç–¾æƒ…å†µã€å°±åŒ»æƒ…å†µã€æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›ç­‰ï¼‰

ã€ç»æµçŠ¶å†µã€‘
ï¼ˆæ”¶å…¥æ¥æºã€å°±ä¸šæƒ…å†µã€ä½ä¿/è¡¥è´´ã€å€ºåŠ¡æƒ…å†µã€æ¶ˆè´¹æ”¯å‡ºç­‰ï¼‰

ã€å…¶ä»–æƒ…å†µã€‘
ï¼ˆç¤¾ä¼šæ”¯æŒç½‘ç»œã€å¿ƒç†çŠ¶æ€ã€ç‰¹æ®Šéœ€æ±‚ã€æœåŠ¡æ„æ„¿ã€å…¶ä»–é‡è¦ä¿¡æ¯ç­‰ï¼‰

è¦æ±‚ï¼šè¯­è¨€ç®€æ´å®¢è§‚ï¼Œä½¿ç”¨ç¤¾å·¥ä¸“ä¸šæœ¯è¯­ï¼›ä¸æ·»åŠ ä¸»è§‚åˆ¤æ–­ã€‚`
              },
              { role: "user", content: text }
            ],
            temperature: 0.1
          })
        });

        const data = await response.json();
        if (response.ok) {
           let aiReply = data.choices[0].message.content.trim();
           resultDiv.innerText = aiReply;
           statusDiv.innerText = "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæ¯•ï¼ä½ å¯ä»¥ç‚¹å‡»å³ä¸‹è§’ä¸€é”®å¤åˆ¶ã€‚";
           
           const textLength = aiReply.replace(/\s+/g, '').length;
           wordCountSpan.innerText = textLength + " å­—";
        } else {
           resultDiv.innerText = "é”™è¯¯è¯¦æƒ…:\n" + JSON.stringify(data.error, null, 2);
           statusDiv.innerText = "âŒ åˆ†æå¤±è´¥ã€‚";
        }
      } catch (error) {
        resultDiv.innerText = "ç½‘ç»œå¼‚å¸¸ï¼š" + error.message;
        statusDiv.innerText = "âŒ è¯·æ±‚å¤§æ¨¡å‹è¶…æ—¶æˆ–å¤±è´¥ã€‚";
      }
    }
  </script>

</body>

</html>

