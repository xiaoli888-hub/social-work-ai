<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹ (DeepSeek é«˜çº§ç‰ˆ)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f5f7; color: #333;}
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px;}
    button.primary-btn { padding: 14px 20px; font-size: 16px; font-weight: bold; margin-top: 15px; border-radius: 8px; border: none; cursor: pointer; width: 100%; transition: 0.2s; color: white;}
    #startBtn { background-color: #07c160; }
    #stopBtn { background-color: #fa5151; display: none; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #status { text-align: center; margin: 15px 0; font-size: 14px; color: #888; font-weight: bold;}
    #timer { font-size: 18px; color: #fa5151; font-weight: bold; margin-left: 5px;}
    
    #reportCard { display: none; padding-bottom: 10px; }
    #result { margin-top: 10px; white-space: pre-wrap; font-size: 15px; line-height: 1.8; color: #222; }
    
    .report-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; }
    .word-count { color: #999; font-size: 14px; }
    .copy-btn { padding: 8px 16px; font-size: 14px; background-color: #f0f0f0; border: 1px solid #ddd; border-radius: 6px; color: #555; cursor: pointer; transition: 0.2s;}
    .copy-btn:hover { background-color: #e4e4e4; }
  </style>
</head>
<body>

  <h2 style="text-align: center;">ğŸ¤ AI ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹ (DeepSeekç‰ˆ)</h2>

  <div class="card">
    <label style="font-size: 14px; font-weight: bold;">ğŸ”‘ DeepSeek API Key (ç”¨äºæ’ç‰ˆæ•´ç†):</label>
    <input type="password" id="deepseekApiKey" placeholder="è¾“å…¥ DeepSeek API Key (sk-å¼€å¤´)">
    
    <label style="font-size: 14px; font-weight: bold; display: block; margin-top: 15px;">ğŸ”‘ Groq API Key (ç”¨äºè¶…å¼ºè¯­éŸ³è½¬å­—):</label>
    <input type="password" id="groqApiKey" placeholder="è¾“å…¥ Groq API Key (gsk_å¼€å¤´)">
    
    <label style="font-size: 14px; font-weight: bold; display: block; margin-top: 15px;">ğŸ—£ï¸ å¼•å¯¼æ¨¡å‹è¯†åˆ«è¯­è¨€ (æ–¹è¨€ä¹Ÿé€‰ä¸­æ–‡):</label>
    <select id="langSelect">
      <option value="zh">ä¸­æ–‡ (åŒ…å«æ™®é€šè¯åŠå„åœ°æ–¹è¨€)</option>
      <option value="en">è‹±æ–‡</option>
    </select>
  </div>

  <div class="card">
    <button id="startBtn" class="primary-btn">â–¶ï¸ å¼€å§‹å½•éŸ³è®¿è°ˆ</button>
    <button id="stopBtn" class="primary-btn">â¹ï¸ ç»“æŸå½•éŸ³å¹¶å¼€å§‹ AI å¤„ç†</button>
    
    <div id="status">å‡†å¤‡å°±ç»ª...</div>
    
    <label style="font-size: 14px; font-weight: bold;">ğŸ“ ç²¾å‡†è¯­éŸ³è½¬å†™ç»“æœ (æ”¯æŒæ–¹è¨€):</label>
    <textarea id="transcript" rows="6" placeholder="å½•éŸ³ç»“æŸåï¼ŒWhisper å¤§æ¨¡å‹è¯†åˆ«çš„æ–‡å­—ä¼šå‡ºç°åœ¨è¿™é‡Œ..."></textarea>
  </div>

  <div class="card" id="reportCard">
    <h3 style="margin-top: 0; text-align: center; color: #07c160;">ğŸ“‘ ç¤¾å·¥è®¿è°ˆæ•´ç†è®°å½•</h3>
    <div id="result"></div>
    
    <div class="report-footer">
      <span class="word-count" id="wordCount">0 å­—</span>
      <button class="copy-btn" id="copyBtn">å¤åˆ¶å…¨æ–‡</button>
    </div>
  </div>

  <script>
    // 1. åˆå§‹åŒ–å¹¶ä¿å­˜ä¸¤ä¸ª API Key
    const deepseekApiKeyInput = document.getElementById('deepseekApiKey');
    const groqApiKeyInput = document.getElementById('groqApiKey');
    
    // ä»æœ¬åœ°å­˜å‚¨è¯»å–
    deepseekApiKeyInput.value = localStorage.getItem('deepseek_api_key') || '';
    groqApiKeyInput.value = localStorage.getItem('groq_api_key') || '';
    
    // ç›‘å¬è¾“å…¥å¹¶ä¿å­˜åˆ°æœ¬åœ°
    deepseekApiKeyInput.addEventListener('input', function() { localStorage.setItem('deepseek_api_key', this.value); });
    groqApiKeyInput.addEventListener('input', function() { localStorage.setItem('groq_api_key', this.value); });

    // 2. å½•éŸ³å¼•æ“ç›¸å…³å˜é‡
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let secondsRecorded = 0;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const transcriptArea = document.getElementById('transcript');
    const reportCard = document.getElementById('reportCard');
    const resultDiv = document.getElementById('result');
    const langSelect = document.getElementById('langSelect');
    const wordCountSpan = document.getElementById('wordCount');
    const copyBtn = document.getElementById('copyBtn');

    // æ ¼å¼åŒ–æ—¶é—´æ˜¾ç¤º (ä¾‹å¦‚ 01:05)
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // 3. ç‚¹å‡»å¼€å§‹å½•éŸ³
    startBtn.onclick = async () => {
      if (!deepseekApiKeyInput.value.trim() || !groqApiKeyInput.value.trim()) {
        alert("è¯·å…ˆå¡«å†™é¡¶éƒ¨çš„ä¸¤ä¸ª API Keyï¼");
        return;
      }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (event) => {
          if (event.data.size > 0) audioChunks.push(event.data);
        };

        mediaRecorder.onstop = async () => {
          stream.getTracks().forEach(track => track.stop());
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          
          if (audioChunks.length === 0) {
              statusDiv.innerHTML = "âŒ å½•éŸ³å¤±è´¥ï¼Œæ²¡æœ‰æ•æ‰åˆ°å£°éŸ³ã€‚";
              return;
          }

          // å¼€å¯å…¨è‡ªåŠ¨åŒæ¨¡å‹å¤„ç†æµæ°´çº¿
          await processAudioAndText(audioBlob);
        };

        mediaRecorder.start(1000); 
        
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        transcriptArea.value = '';
        reportCard.style.display = 'none';
        
        secondsRecorded = 0;
        statusDiv.innerHTML = `ğŸ”´ æ­£åœ¨å½•éŸ³ä¸­ <span id="timer">00:00</span>`;
        recordingTimer = setInterval(() => {
          secondsRecorded++;
          document.getElementById('timer').innerText = formatTime(secondsRecorded);
        }, 1000);

      } catch (err) {
        console.error("éº¦å…‹é£å¯åŠ¨å¤±è´¥:", err);
        alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿æ‚¨å·²æˆäºˆæµè§ˆå™¨éº¦å…‹é£æƒé™ï¼\né”™è¯¯è¯¦æƒ…: " + err.message);
      }
    };

    // 4. ç‚¹å‡»ç»“æŸå½•éŸ³
    stopBtn.onclick = () => {
      clearInterval(recordingTimer);
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      statusDiv.innerHTML = "â³ å½•éŸ³å·²ç»“æŸï¼Œæ­£åœ¨æ‰“åŒ…éŸ³é¢‘...";
      mediaRecorder.stop(); 
    };

    // 5. æ ¸å¿ƒå¤§æ¨¡å‹æµæ°´çº¿ï¼šGroq (è¯­éŸ³è½¬æ–‡å­—) -> DeepSeek (æ–‡å­—æ’ç‰ˆ)
    async function processAudioAndText(audioBlob) {
      const groqKey = groqApiKeyInput.value.trim();
      const deepseekKey = deepseekApiKeyInput.value.trim();
      
      try {
        // ========== é˜¶æ®µä¸€ï¼šè°ƒç”¨ Groq Whisper å¤§æ¨¡å‹è¿›è¡Œè¯­éŸ³è¯†åˆ« ==========
        statusDiv.innerHTML = "â³ [1/2] æ­£åœ¨å‘é€è‡³ Groq Whisper å¤§æ¨¡å‹è¯†åˆ«è¯­éŸ³...";
        
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm'); 
        formData.append('model', 'whisper-large-v3');
        formData.append('language', langSelect.value); 

        const groqResponse = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${groqKey}` },
          body: formData
        });

        const groqData = await groqResponse.json();
        
        if (!groqResponse.ok) {
            throw new Error(`Groq è¯­éŸ³è¯†åˆ«å¤±è´¥: ${groqData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        }

        const transcriptText = groqData.text.trim();
        transcriptArea.value = transcriptText;

        if (!transcriptText) {
             statusDiv.innerHTML = "âš ï¸ å½•éŸ³å¤ªçŸ­æˆ–å…¨æ˜¯é™éŸ³ï¼Œæ¨¡å‹æœªè¯†åˆ«å‡ºæ–‡å­—ã€‚";
             return;
        }

        // ========== é˜¶æ®µäºŒï¼šè°ƒç”¨ DeepSeek å¤§æ¨¡å‹è¿›è¡Œæ•´ç†æ’ç‰ˆ ==========
        statusDiv.innerHTML = "â³ [2/2] è¯­éŸ³è¯†åˆ«å®Œæˆï¼æ­£åœ¨äº¤ç»™ DeepSeek æ•´ç†æ’ç‰ˆ...";
        reportCard.style.display = 'block';
        resultDiv.innerText = "æ·±å…¥åˆ†æä¸æ’ç‰ˆä¸­...";

        // æ³¨æ„è¿™é‡Œï¼šåœ°å€æ¢æˆäº† DeepSeek çš„å®˜æ–¹æ¥å£
        const deepseekResponse = await fetch('https://api.deepseek.com/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${deepseekKey}`
          },
          body: JSON.stringify({
            model: "deepseek-chat", // ä½¿ç”¨ DeepSeek çš„å¯¹è¯æ¨¡å‹
            messages: [
              {
                role: "system",
                content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾å·¥åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„åŸå§‹å£è¯­åŒ–è®¿è°ˆè®°å½•ï¼Œæç‚¼å¹¶æ•´ç†æˆæ­£å¼çš„ç¤¾å·¥æ–‡ä¹¦æŠ¥å‘Šã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ’ç‰ˆæ ¼å¼è¾“å‡ºï¼š

ã€å®¶åº­æƒ…å†µã€‘
ï¼ˆå®¶åº­æˆå‘˜æ„æˆã€å®¶åº­å…³ç³»ã€å©šå§»çŠ¶å†µã€å­å¥³æƒ…å†µã€å®¶åº­æ”¯æŒç­‰ï¼‰å¦‚æœæ²¡æœ‰åˆ™ç•™ç©º

ã€èº«ä½“çŠ¶å†µã€‘
ï¼ˆå¥åº·çŠ¶å†µã€ç–¾ç—…å²ã€æ®‹ç–¾æƒ…å†µã€å°±åŒ»æƒ…å†µã€æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›ç­‰ï¼‰ï¼Œå¦‚æœæ²¡æœ‰åˆ™ç•™ç©º

ã€ç»æµçŠ¶å†µã€‘
æ”¶å…¥æ¥æºã€å°±ä¸šæƒ…å†µã€ä½ä¿/è¡¥è´´ã€å€ºåŠ¡æƒ…å†µã€æ¶ˆè´¹æ”¯å‡ºç­‰ï¼‰å¦‚æœæ²¡æœ‰åˆ™ç•™ç©º

ã€å…¶ä»–æƒ…å†µã€‘
ï¼ˆå±…ä½æƒ…å†µã€ç¤¾ä¼šæ”¯æŒç½‘ç»œã€å¿ƒç†çŠ¶æ€ã€ç‰¹æ®Šéœ€æ±‚ã€æœåŠ¡æ„æ„¿ã€å…¶ä»–é‡è¦ä¿¡æ¯ç­‰ï¼‰ï¼Œå½“æ²¡æœ‰æœåŠ¡éœ€æ±‚æˆ–æœåŠ¡æ„æ„¿æ—¶ï¼Œè¯·æ³¨æ˜æš‚æ—¶æ²¡æœ‰éœ€æ±‚

ä¸¥æ ¼è¦æ±‚ï¼š
1. ä¸è¦ä½¿ç”¨ä»»ä½• Markdown è¯­æ³•æ ‡è®°ï¼ˆæ¯”å¦‚ä¸è¦ç”¨ ** åŠ ç²—ï¼‰ã€‚
2. åªè¾“å‡ºä¸Šè¿°å››ä¸ªæ¨¡å—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºå¤šä½™çš„å¼€å¤´é—®å€™æˆ–ç»“å°¾æ€»ç»“ã€‚
3. æå–å®¢è§‚äº‹å®ï¼Œå»é™¤è¯­æ°”è¯ï¼Œè¯­è¨€è¦ä¸“ä¸šä¸¥è°¨ã€‚`
              },
              { role: "user", content: transcriptText }
            ],
            temperature: 0.1 // è¾ƒä½çš„æ¸©åº¦ä¿è¯æ’ç‰ˆçš„ç¨³å®šæ€§
          })
        });

        const deepseekData = await deepseekResponse.json();
        
        if (deepseekResponse.ok) {
           let aiReply = deepseekData.choices[0].message.content.trim();
           resultDiv.innerText = aiReply;
           statusDiv.innerHTML = "âœ… <span style='color: #07c160;'>å…¨æµç¨‹å¤„ç†å®Œæ¯•ï¼ä½ å¯ä»¥ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®å¤åˆ¶ã€‚</span>";
           
           const textLength = aiReply.replace(/\s+/g, '').length;
           wordCountSpan.innerText = textLength + " å­—";
        } else {
           throw new Error(`DeepSeek åˆ†æå¤±è´¥: ${JSON.stringify(deepseekData.error)}`);
        }

      } catch (error) {
        console.error("æµæ°´çº¿å¤„ç†å‡ºé”™:", error);
        statusDiv.innerHTML = `<span style="color:red;">âŒ å¤„ç†å¤±è´¥: ${error.message}</span>`;
      }
    }

    // 6. å¤åˆ¶å…¨æ–‡åŠŸèƒ½
    copyBtn.onclick = () => {
      const textToCopy = resultDiv.innerText;
      if (!textToCopy) return;

      navigator.clipboard.writeText(textToCopy).then(() => {
        const originalText = copyBtn.innerText;
        copyBtn.innerText = "âœ… å¤åˆ¶æˆåŠŸ";
        copyBtn.style.backgroundColor = "#e6f7eb";
        copyBtn.style.color = "#07c160";
        copyBtn.style.borderColor = "#07c160";
        
        setTimeout(() => {
          copyBtn.innerText = originalText;
          copyBtn.style.backgroundColor = "#f0f0f0";
          copyBtn.style.color = "#555";
          copyBtn.style.borderColor = "#ddd";
        }, 2000);
      }).catch(err => {
        alert("å¤åˆ¶å¤±è´¥ï¼Œè¯·æ‰‹åŠ¨é•¿æŒ‰æ–‡å­—é€‰æ‹©å¤åˆ¶ã€‚");
      });
    };
  </script>

</body>
</html>
