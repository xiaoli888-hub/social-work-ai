<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¾å·¥å…¨èƒ½åŠå…¬åŠ©æ‰‹ (DeepSeekå¢å¼ºç‰ˆ)</title>
  <style>
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f5f7; color: #333;}
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    .section-title { font-size: 15px; font-weight: bold; color: #07c160; border-bottom: 2px solid #07c160; padding-bottom: 5px; margin-bottom: 15px; display: inline-block; }
    input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px;}
    label { font-size: 14px; font-weight: bold; display: block; margin-top: 15px; color: #555;}
    
    button.primary-btn { padding: 14px 20px; font-size: 16px; font-weight: bold; margin-top: 15px; border-radius: 8px; border: none; cursor: pointer; width: 100%; transition: 0.2s; color: white;}
    #startBtn { background-color: #07c160; }
    #stopBtn { background-color: #fa5151; display: none; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    
    #status { text-align: center; margin: 15px 0; font-size: 14px; color: #888; font-weight: bold;}
    #timer { font-size: 18px; color: #fa5151; font-weight: bold; margin-left: 5px;}
    
    #reportCard { display: none; padding-bottom: 10px; }
    #result { margin-top: 10px; white-space: pre-wrap; font-size: 15px; line-height: 1.8; color: #222; }
    
    .report-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; padding-top: 15px; border-top: 1px solid #eee; flex-wrap: wrap; gap: 10px;}
    .word-count { color: #999; font-size: 14px; }
    .action-buttons { display: flex; flex-wrap: wrap; gap: 10px; width: 100%; justify-content: flex-end;}
    
    .tool-btn { padding: 8px 14px; font-size: 14px; border-radius: 6px; cursor: pointer; transition: 0.2s; font-weight: bold; border: 1px solid;}
    .copy-btn { background-color: #f0f0f0; border-color: #ddd; color: #555; }
    .word-btn { background-color: #e6f7ff; border-color: #91d5ff; color: #1890ff; }
    .email-btn { background-color: #fff0f6; border-color: #ffadd2; color: #eb2f96; }
    .tool-btn:hover { filter: brightness(0.95); }
  </style>
</head>
<body>

  <h2 style="text-align: center;">ğŸ¤ AI ç¤¾å·¥å…¨èƒ½åŠ©æ‰‹</h2>

  <div class="card">
    <div class="section-title">âš™ï¸ æ ¸å¿ƒè®¾ç½®</div>
    
    <label style="margin-top: 0;">ğŸ¢ 1. é€‰æ‹©å½“å‰å·¥ä½œåœºæ™¯ (å†³å®šæ’ç‰ˆæ ¼å¼):</label>
    <select id="scenarioSelect">
      <option value="resident">1ï¸âƒ£ ç¤¾å·¥è®¿è°ˆå±…æ°‘ (ä¸ªæ¡ˆé¢è°ˆ)</option>
      <option value="meeting">2ï¸âƒ£ æ•´ç†ä¼šè®®çºªè¦ (å·¥ä½œä¼šè®®)</option>
      <option value="supervision">3ï¸âƒ£ ç¤¾å·¥é›†ä½“ç£å¯¼ (ä¸“ä¸šç£å¯¼)</option>
    </select>

    <label>ğŸ—£ï¸ 2. å¼•å¯¼æ¨¡å‹è¯†åˆ«è¯­è¨€:</label>
    <select id="langSelect">
      <option value="zh">æ™®é€šè¯åŠå…¶ä»–æ–¹è¨€ (ä¸­æ–‡)</option>
      <option value="yue">çº¯æ­£ç²¤è¯­ (å¹¿ä¸œè¯)</option> 
    </select>

    <label>ğŸ“§ 3. é»˜è®¤æ¥æ”¶æŠ¥å‘Šçš„é‚®ç®± (ç”¨äºä¸€é”®å‘é€):</label>
    <input type="email" id="targetEmail" placeholder="ä¾‹å¦‚: your-email@qq.com">
  </div>

  <div class="card" style="display: none;">
    </div>
  
  <div class="card">
    <div class="section-title">ğŸ”‘ å¯†é’¥é…ç½® (æœ¬åœ°å­˜å‚¨)</div>
    <label style="margin-top:0;">DeepSeek API Key (æ’ç‰ˆå¤§è„‘):</label>
    <input type="password" id="deepseekApiKey" placeholder="sk-...">
    <label>Groq API Key (è¯­éŸ³å¼•æ“):</label>
    <input type="password" id="groqApiKey" placeholder="gsk_...">
  </div>

  <div class="card">
    <button id="startBtn" class="primary-btn">â–¶ï¸ å¼€å§‹å½•éŸ³</button>
    <button id="stopBtn" class="primary-btn">â¹ï¸ ç»“æŸå½•éŸ³å¹¶ç”Ÿæˆä¸“ä¸šæŠ¥å‘Š</button>
    
    <div id="status">å‡†å¤‡å°±ç»ª...</div>
    
    <label>ğŸ“ è¯­éŸ³ç²¾å‡†è½¬å†™ç»“æœ (æ”¯æŒæ–¹è¨€):</label>
    <textarea id="transcript" rows="6" placeholder="å½•éŸ³ç»“æŸåï¼ŒåŸå§‹è¯­éŸ³å¯¹åº”çš„æ–‡å­—ä¼šå‡ºç°åœ¨è¿™é‡Œ..."></textarea>
  </div>

  <div class="card" id="reportCard">
    <h3 style="margin-top: 0; text-align: center; color: #07c160;" id="reportTitle">ğŸ“‘ æ™ºèƒ½æ•´ç†æŠ¥å‘Š</h3>
    <div id="result"></div>
    
    <div class="report-footer">
      <span class="word-count" id="wordCount">0 å­—</span>
      <div class="action-buttons">
        <button class="tool-btn copy-btn" id="copyBtn">å¤åˆ¶å…¨æ–‡</button>
        <button class="tool-btn word-btn" id="exportWordBtn">â¬‡ï¸ å¯¼å‡º Word</button>
        <button class="tool-btn email-btn" id="sendEmailBtn">âœ‰ï¸ é‚®ä»¶å‘é€</button>
      </div>
    </div>
  </div>

  <script>
    // ========== 1. æœ¬åœ°å­˜å‚¨åˆå§‹åŒ– ==========
    const elements = ['deepseekApiKey', 'groqApiKey', 'targetEmail'];
    elements.forEach(id => {
      const el = document.getElementById(id);
      el.value = localStorage.getItem(id) || '';
      el.addEventListener('input', function() { localStorage.setItem(id, this.value); });
    });

    // ========== 2. ä¸‰å¥—ä¸“å®¶çº§æç¤ºè¯åº“ ==========
    const prompts = {
      // åœºæ™¯ä¸€ï¼šç¤¾å·¥è®¿è°ˆå±…æ°‘ (å®Œå…¨ä½¿ç”¨ä½ çš„è®¾å®š)
      resident: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾å·¥åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„åŸå§‹å£è¯­åŒ–è®¿è°ˆè®°å½•ï¼Œæç‚¼å¹¶æ•´ç†æˆæ­£å¼çš„ç¤¾å·¥æ–‡ä¹¦æŠ¥å‘Šã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ’ç‰ˆæ ¼å¼è¾“å‡ºï¼ˆç›´æ¥è¾“å‡ºæ’ç‰ˆå¥½çš„çº¯æ–‡æœ¬ï¼Œç»å¯¹ä¸è¦è¾“å‡º markdown çš„ json ä»£ç å—ï¼‰ï¼š

ã€å®¶åº­æƒ…å†µã€‘
ï¼ˆå®¶åº­æˆå‘˜æ„æˆã€å®¶åº­å…³ç³»ã€å©šå§»çŠ¶å†µã€å­å¥³æƒ…å†µã€å®¶åº­æ”¯æŒç­‰ï¼‰

ã€èº«ä½“çŠ¶å†µã€‘
ï¼ˆå¥åº·çŠ¶å†µã€ç–¾ç—…å²ã€æ®‹ç–¾æƒ…å†µã€å°±åŒ»æƒ…å†µã€æ—¥å¸¸ç”Ÿæ´»èƒ½åŠ›ç­‰ï¼‰

ã€ç»æµçŠ¶å†µã€‘
ï¼ˆæ”¶å…¥æ¥æºã€å°±ä¸šæƒ…å†µã€ä½ä¿/è¡¥è´´ã€å€ºåŠ¡æƒ…å†µã€æ¶ˆè´¹æ”¯å‡ºç­‰ï¼‰

ã€å…¶ä»–æƒ…å†µã€‘
ï¼ˆå±…ä½æƒ…å†µã€ç¤¾ä¼šæ”¯æŒç½‘ç»œã€å¿ƒç†çŠ¶æ€ã€ç‰¹æ®Šéœ€æ±‚ã€æœåŠ¡æ„æ„¿ã€å…¶ä»–é‡è¦ä¿¡æ¯ç­‰ï¼‰ï¼Œå½“æ²¡æœ‰æœåŠ¡éœ€æ±‚æˆ–æœåŠ¡æ„æ„¿æ—¶ï¼Œè¯·æ³¨æ˜æš‚æ—¶æ²¡æœ‰éœ€æ±‚

ä¸¥æ ¼è¦æ±‚ï¼š
1. ä¸è¦ä½¿ç”¨ä»»ä½• Markdown è¯­æ³•æ ‡è®°ï¼ˆæ¯”å¦‚ä¸è¦ç”¨ ** åŠ ç²—ï¼‰ã€‚
2. åªè¾“å‡ºä¸Šè¿°å››ä¸ªæ¨¡å—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºå¤šä½™çš„å¼€å¤´é—®å€™æˆ–ç»“å°¾æ€»ç»“ã€‚
3. æå–å®¢è§‚äº‹å®ï¼Œå»é™¤è¯­æ°”è¯ï¼Œè¯­è¨€è¦ä¸“ä¸šä¸¥è°¨ã€‚`,

      // åœºæ™¯äºŒï¼šæ•´ç†ä¼šè®®çºªè¦
      meeting: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„è¡Œæ”¿åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„å£è¯­åŒ–æˆ–å‡Œä¹±çš„ä¼šè®®å‘è¨€è®°å½•ï¼Œæç‚¼å¹¶æ•´ç†æˆç»“æ„æ¸…æ™°ã€æ­£å¼ä¸¥è°¨çš„ä¼šè®®çºªè¦ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ’ç‰ˆæ ¼å¼è¾“å‡ºï¼ˆç›´æ¥è¾“å‡ºæ’ç‰ˆå¥½çš„çº¯æ–‡æœ¬ï¼Œç»å¯¹ä¸è¦è¾“å‡º markdown ç­‰æ ‡è®°ç¬¦å·ï¼‰ï¼š

ã€ä¼šè®®èƒŒæ™¯ä¸è®®é¢˜ã€‘
ï¼ˆæç‚¼æœ¬æ¬¡ä¼šè®®çš„ä¸»è¦ç›®çš„ã€æ ¸å¿ƒè®¨è®ºçš„è®®é¢˜ã€‚å¦‚æœæ²¡æœ‰æ˜ç¡®è¯´æ˜ï¼Œè¯·æ ¹æ®å†…å®¹æ¨æ–­æˆ–ç•™ç©ºï¼‰

ã€æ ¸å¿ƒè®¨è®ºå†…å®¹ã€‘
ï¼ˆå½’çº³ä¼šè®®ä¸­å„æ–¹è¡¨è¾¾çš„ä¸»è¦è§‚ç‚¹ã€åæ˜ çš„é—®é¢˜ã€æä¾›çš„æ•°æ®æˆ–ç°çŠ¶ã€‚åˆ†æ¡ç†å®¢è§‚é™ˆè¿°ï¼‰

ã€ä¼šè®®å†³è®®ã€‘
ï¼ˆæ˜ç¡®ä¼šè®®æœ€ç»ˆè¾¾æˆçš„å…±è¯†ã€åšå‡ºçš„å†³å®šã€‚å¦‚æœæœªå½¢æˆå†³è®®ï¼Œè¯·æ³¨æ˜â€œæš‚æ— æ˜ç¡®å†³è®®â€ï¼‰

ã€ä¸‹ä¸€æ­¥è¡ŒåŠ¨è®¡åˆ’ã€‘
ï¼ˆåˆ—å‡ºä¼šè®®å®‰æ’çš„åç»­è·Ÿè¿›äº‹é¡¹ã€è´£ä»»äººæˆ–æ—¶é—´èŠ‚ç‚¹ã€‚å¦‚æœæ²¡æœ‰ï¼Œè¯·æ³¨æ˜â€œæ— æ˜ç¡®åç»­è·Ÿè¿›äº‹é¡¹â€ï¼‰

ä¸¥æ ¼è¦æ±‚ï¼š
1. ä¸è¦ä½¿ç”¨ä»»ä½• Markdown è¯­æ³•æ ‡è®°ï¼ˆæ¯”å¦‚ä¸è¦ç”¨ ** åŠ ç²—ï¼‰ã€‚
2. åªè¾“å‡ºä¸Šè¿°å››ä¸ªæ¨¡å—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºå¤šä½™çš„å¼€å¤´é—®å€™æˆ–ç»“å°¾æ€»ç»“ã€‚
3. æå–å®¢è§‚äº‹å®ï¼Œè¯­è¨€è¦é«˜åº¦ç²¾ç‚¼ã€å®˜æ–¹ã€ä¸“ä¸šã€‚`,

      // åœºæ™¯ä¸‰ï¼šç¤¾å·¥é›†ä½“ç£å¯¼
      supervision: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾ä¼šå·¥ä½œç£å¯¼åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„å£è¯­åŒ–ç£å¯¼äº¤æµè¿‡ç¨‹ï¼Œæç‚¼å¹¶æ•´ç†æˆä¸“ä¸šã€è§„èŒƒçš„ç¤¾å·¥é›†ä½“ç£å¯¼è®°å½•ã€‚
è¯·ä¸¥æ ¼æŒ‰ç…§ä»¥ä¸‹æ’ç‰ˆæ ¼å¼è¾“å‡ºï¼ˆç›´æ¥è¾“å‡ºæ’ç‰ˆå¥½çš„çº¯æ–‡æœ¬ï¼Œç»å¯¹ä¸è¦è¾“å‡º markdown ç­‰æ ‡è®°ç¬¦å·ï¼‰ï¼š

ã€ç£å¯¼ä¸»é¢˜ä¸æ¡ˆä¾‹æƒ…å†µã€‘
ï¼ˆç®€è¿°æœ¬æ¬¡ç£å¯¼æ¢è®¨çš„æ ¸å¿ƒä¸»é¢˜ï¼Œæˆ–ç¤¾å·¥å‘ˆæŠ¥çš„ä¸ªæ¡ˆ/ç¤¾åŒºæ´»åŠ¨åŸºæœ¬èƒŒæ™¯ä¸ç°çŠ¶ã€‚ï¼‰

ã€ç¤¾å·¥å›°æƒ‘ä¸å®åŠ¡éš¾ç‚¹ã€‘
ï¼ˆå½’çº³ä¸€çº¿ç¤¾å·¥åœ¨å®åŠ¡æ“ä½œä¸­é‡åˆ°çš„é˜»ç¢ã€æƒ…ç»ªå‹åŠ›ã€ä¼¦ç†å›°å¢ƒæˆ–ä¸“ä¸šæŠ€èƒ½ç“¶é¢ˆã€‚ï¼‰

ã€ç£å¯¼å›åº”ä¸å›¢é˜Ÿå»ºè®®ã€‘
ï¼ˆæ•´ç†ç£å¯¼è€…ç»™äºˆçš„ä¸“ä¸šæŒ‡å¯¼æ„è§ï¼Œä»¥åŠå›¢é˜Ÿå…¶ä»–æˆå‘˜æä¾›çš„å¤šè§†è§’å»ºè®®ã€èµ„æºé“¾æ¥æ€è·¯ã€‚ï¼‰

ã€åç»­è·Ÿè¿›è®¡åˆ’ä¸åæ€ã€‘
ï¼ˆæ€»ç»“ç¤¾å·¥åœ¨è·å¾—ç£å¯¼åçš„è¡ŒåŠ¨æ–¹æ¡ˆã€æœåŠ¡ç­–ç•¥è°ƒæ•´æ–¹å‘ï¼Œæˆ–ä¸“ä¸šä»·å€¼è§‚ä¸Šçš„åæ€ã€‚ï¼‰

ä¸¥æ ¼è¦æ±‚ï¼š
1. ä¸è¦ä½¿ç”¨ä»»ä½• Markdown è¯­æ³•æ ‡è®°ï¼ˆæ¯”å¦‚ä¸è¦ç”¨ ** åŠ ç²—ï¼‰ã€‚
2. åªè¾“å‡ºä¸Šè¿°å››ä¸ªæ¨¡å—ï¼Œç»å¯¹ä¸è¦è¾“å‡ºå¤šä½™çš„å¼€å¤´é—®å€™æˆ–ç»“å°¾æ€»ç»“ã€‚
3. æå–å®¢è§‚äº‹å®ï¼Œé€‚å½“ä½¿ç”¨ç¤¾å·¥ä¸“ä¸šæœ¯è¯­ï¼ˆå¦‚æ¡ˆä¸»ã€èµ‹æƒã€åŒç†å¿ƒã€èµ„æºé“¾æ¥ç­‰ï¼‰ï¼Œè¯­è¨€ä¸¥è°¨ã€‚`
    };

    // ========== 3. å½•éŸ³ä¸æ ¸å¿ƒå¼•æ“ ==========
    let mediaRecorder;
    let audioChunks = [];
    let recordingTimer;
    let secondsRecorded = 0;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const transcriptArea = document.getElementById('transcript');
    const reportCard = document.getElementById('reportCard');
    const resultDiv = document.getElementById('result');
    const scenarioSelect = document.getElementById('scenarioSelect');
    const langSelect = document.getElementById('langSelect');
    
    function formatTime(seconds) {
      const m = Math.floor(seconds / 60).toString().padStart(2, '0');
      const s = (seconds % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    startBtn.onclick = async () => {
      const deepseekKey = document.getElementById('deepseekApiKey').value.trim();
      const groqKey = document.getElementById('groqApiKey').value.trim();
      if (!deepseekKey || !groqKey) { alert("è¯·å…ˆåœ¨ä¸‹æ–¹å¡«å†™å¥½ç›¸å…³çš„ API Keyï¼"); return; }

      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);
        audioChunks = [];

        mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) audioChunks.push(e.data); };

        mediaRecorder.onstop = async () => {
          stream.getTracks().forEach(track => track.stop());
          if (audioChunks.length === 0) { statusDiv.innerHTML = "âŒ å½•éŸ³å¤±è´¥ï¼Œæ²¡æœ‰æ•æ‰åˆ°å£°éŸ³ã€‚"; return; }
          const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
          await processAudioAndText(audioBlob);
        };

        mediaRecorder.start(1000); 
        startBtn.style.display = 'none'; stopBtn.style.display = 'block';
        transcriptArea.value = ''; reportCard.style.display = 'none';
        secondsRecorded = 0;
        statusDiv.innerHTML = `ğŸ”´ æ­£åœ¨å½•éŸ³ä¸­ <span id="timer">00:00</span>`;
        recordingTimer = setInterval(() => {
          secondsRecorded++;
          document.getElementById('timer').innerText = formatTime(secondsRecorded);
        }, 1000);
      } catch (err) { alert("éº¦å…‹é£å¯åŠ¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æƒé™ï¼\n" + err.message); }
    };

    stopBtn.onclick = () => {
      clearInterval(recordingTimer);
      startBtn.style.display = 'block'; stopBtn.style.display = 'none';
      statusDiv.innerHTML = "â³ æ­£åœ¨æ‰“åŒ…éŸ³é¢‘...";
      mediaRecorder.stop(); 
    };

    async function processAudioAndText(audioBlob) {
      const groqKey = document.getElementById('groqApiKey').value.trim();
      const deepseekKey = document.getElementById('deepseekApiKey').value.trim();
      const currentScenario = scenarioSelect.value;
      const systemPrompt = prompts[currentScenario]; // æ ¹æ®ä¸‹æ‹‰æ¡†åŠ¨æ€è·å–å¯¹åº”æç¤ºè¯
      
      try {
        // [é˜¶æ®µ1ï¼šè¯­éŸ³è¯†åˆ«]
        statusDiv.innerHTML = "â³ [1/2] æ­£åœ¨å‘é€è‡³ Groq è¯†åˆ«è¯­éŸ³...";
        const formData = new FormData();
        formData.append('file', audioBlob, 'recording.webm'); 
        formData.append('model', 'whisper-large-v3');
        formData.append('language', langSelect.value); 

        const groqRes = await fetch('https://api.groq.com/openai/v1/audio/transcriptions', { method: 'POST', headers: { 'Authorization': `Bearer ${groqKey}` }, body: formData });
        const groqData = await groqRes.json();
        if (!groqRes.ok) throw new Error(`è¯­éŸ³è¯†åˆ«å¤±è´¥: ${groqData.error?.message || 'æœªçŸ¥é”™è¯¯'}`);
        
        const text = groqData.text.trim();
        transcriptArea.value = text;
        if (!text) { statusDiv.innerHTML = "âš ï¸ æœªè¯†åˆ«åˆ°æœ‰æ•ˆè¯­éŸ³ã€‚"; return; }

        // [é˜¶æ®µ2ï¼šDeepSeek ä¸“å±åœºæ™¯æ’ç‰ˆ]
        statusDiv.innerHTML = "â³ [2/2] è¯­éŸ³å®Œæ¯•ï¼æ­£åœ¨ç”± DeepSeek æŒ‰æŒ‡å®šåœºæ™¯ç”ŸæˆæŠ¥å‘Š...";
        reportCard.style.display = 'block';
        document.getElementById('reportTitle').innerText = `ğŸ“‘ ${scenarioSelect.options[scenarioSelect.selectedIndex].text} æŠ¥å‘Š`;
        resultDiv.innerText = "æ·±å…¥åˆ†æä¸æ’ç‰ˆä¸­...";

        const dsRes = await fetch('https://api.deepseek.com/chat/completions', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${deepseekKey}` },
          body: JSON.stringify({
            model: "deepseek-chat",
            messages: [
              { role: "system", content: systemPrompt }, // æ ¸å¿ƒï¼šä½¿ç”¨åŠ¨æ€æç¤ºè¯
              { role: "user", content: text }
            ],
            temperature: 0.1
          })
        });

        const dsData = await dsRes.json();
        if (dsRes.ok) {
           let aiReply = dsData.choices[0].message.content.trim();
           resultDiv.innerText = aiReply;
           statusDiv.innerHTML = "âœ… <span style='color: #07c160;'>å¤„ç†å®Œæ¯•ï¼è¯·é€‰æ‹©ä¸‹æ–¹æ“ä½œï¼šå¤åˆ¶ / å¯¼å‡º Word / é‚®ä»¶å‘é€ã€‚</span>";
           document.getElementById('wordCount').innerText = aiReply.replace(/\s+/g, '').length + " å­—";
        } else { throw new Error(`æ’ç‰ˆå¤±è´¥: ${JSON.stringify(dsData.error)}`); }
      } catch (error) { statusDiv.innerHTML = `<span style="color:red;">âŒ å¤„ç†å¤±è´¥: ${error.message}</span>`; }
    }

    // ========== 4. ä¸‰å¤§å·¥å…·ç®±åŠŸèƒ½ ==========
    
    // å¤åˆ¶å…¨æ–‡
    document.getElementById('copyBtn').onclick = () => {
      const text = resultDiv.innerText;
      if (!text) return;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.getElementById('copyBtn');
        const orig = btn.innerText; btn.innerText = "âœ… å·²å¤åˆ¶";
        setTimeout(() => { btn.innerText = orig; }, 2000);
      }).catch(err => alert("å¤åˆ¶å¤±è´¥"));
    };

    // å¯¼å‡º Word
    document.getElementById('exportWordBtn').onclick = () => {
      const text = resultDiv.innerText;
      if (!text || text === "æ·±å…¥åˆ†æä¸æ’ç‰ˆä¸­...") return;
      
      const formattedText = text.replace(/\n/g, '<br>');
      const titleName = scenarioSelect.options[scenarioSelect.selectedIndex].text.split(' ')[1]; // æˆªå–åå­—
      const wordHTML = `
        <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'>
        <head><meta charset='utf-8'><title>${titleName}</title>
        <style>body { font-family: 'SimSun', 'å®‹ä½“', 'Microsoft YaHei', sans-serif; font-size: 14pt; line-height: 1.6; } h2 { text-align: center; color: #333; }</style></head>
        <body><h2>${titleName}</h2><div>${formattedText}</div></body></html>`;

      const blob = new Blob(['\ufeff', wordHTML], { type: 'application/msword' });
      const url = URL.createObjectURL(blob);
      const filename = `${titleName}_${new Date().getTime()}.doc`;
      
      const a = document.createElement("a");
      a.href = url; a.download = filename;
      document.body.appendChild(a); a.click();
      document.body.removeChild(a); URL.revokeObjectURL(url);
    };

    // ã€æ–°å¢æ ¸å¿ƒï¼šå”¤èµ·é‚®ä»¶å®¢æˆ·ç«¯å‘é€ã€‘
    document.getElementById('sendEmailBtn').onclick = () => {
      const text = resultDiv.innerText;
      const targetEmail = document.getElementById('targetEmail').value.trim();
      
      if (!text || text === "æ·±å…¥åˆ†æä¸æ’ç‰ˆä¸­...") { alert("æŠ¥å‘Šè¿˜æ²¡ç”Ÿæˆå®Œå‘¢ï¼"); return; }
      if (!targetEmail) { alert("è¯·åœ¨ä¸Šæ–¹è®¾ç½®é‡Œå¡«å†™ã€é»˜è®¤æ¥æ”¶æŠ¥å‘Šçš„é‚®ç®±ã€‘ï¼"); return; }
      
      // è·å–å½“å‰åœºæ™¯åç§°ä½œä¸ºé‚®ä»¶æ ‡é¢˜
      const scenarioName = scenarioSelect.options[scenarioSelect.selectedIndex].text.split(' ')[1];
      const mailSubject = encodeURIComponent(`ã€AIæ•´ç†å‘ˆæŠ¥ã€‘${scenarioName} - ${new Date().toLocaleDateString()}`);
      
      // å°†æ­£æ–‡ç¼–ç æ”¾å…¥é‚®ä»¶ body ä¸­
      const mailBody = encodeURIComponent("è¿™æ˜¯ç”± AI è¾…åŠ©ç”Ÿæˆçš„æŠ¥å‘Šå†…å®¹ï¼š\n\n" + text);
      
      // è§¦å‘å”¤èµ·ç³»ç»Ÿé»˜è®¤é‚®ä»¶å®¢æˆ·ç«¯ (çº¯å‰ç«¯æœ€å®‰å…¨åšæ³•)
      window.location.href = `mailto:${targetEmail}?subject=${mailSubject}&body=${mailBody}`;
    };
  </script>

</body>

</html>
