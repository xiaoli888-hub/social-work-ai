<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹ (æ”¯æŒç²¤è¯­)</title>
  <style>
    body { font-family: sans-serif; padding: 20px; max-width: 600px; margin: 0 auto; background-color: #f4f5f7; }
    .card { background: #fff; padding: 20px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
    input, textarea, select { width: 100%; padding: 12px; margin-top: 8px; box-sizing: border-box; border: 1px solid #e0e0e0; border-radius: 8px; font-size: 15px;}
    button { padding: 14px 20px; font-size: 16px; font-weight: bold; margin-top: 15px; border-radius: 8px; border: none; cursor: pointer; width: 100%; transition: 0.2s;}
    #startBtn { background-color: #07c160; color: white; }
    #stopBtn { background-color: #fa5151; color: white; display: none; }
    button:disabled { background-color: #cccccc; cursor: not-allowed; }
    #status { text-align: center; margin: 15px 0; font-size: 14px; color: #888; }
    #result { margin-top: 10px; white-space: pre-wrap; font-family: monospace; background: #282c34; color: #98c379; padding: 15px; border-radius: 8px; overflow-x: auto; line-height: 1.5;}
    .pulse { animation: pulse-animation 1.5s infinite; color: #fa5151; font-weight: bold;}
    @keyframes pulse-animation { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
  </style>
</head>
<body>

  <h2 style="text-align: center;">ğŸ¤ AI ç¤¾å·¥è®¿è°ˆåŠ©æ‰‹</h2>

  <div class="card">
    <label for="apiKey" style="font-size: 14px; font-weight: bold; color: #333;">ğŸ”‘ æ™ºè°± API Key (æœ¬åœ°å®‰å…¨å­˜å‚¨):</label>
    <input type="password" id="apiKey" placeholder="è¾“å…¥ä½ çš„ API Key">
    
    <label for="langSelect" style="font-size: 14px; font-weight: bold; color: #333; display: block; margin-top: 15px;">ğŸ—£ï¸ é€‰æ‹©å—è®¿è€…è¯­è¨€:</label>
    <select id="langSelect">
      <option value="zh-CN">æ™®é€šè¯</option>
      <option value="zh-HK">ç²¤è¯­ (å¹¿ä¸œè¯)</option>
    </select>
  </div>

  <div class="card">
    <button id="startBtn">â–¶ï¸ å¼€å§‹è®¿è°ˆ (å½•éŸ³å¹¶è½¬æ–‡å­—)</button>
    <button id="stopBtn">â¹ï¸ ç»“æŸè®¿è°ˆ (äº¤ç”± AI æ•´ç†)</button>
    
    <div id="status">å‡†å¤‡å°±ç»ª...</div>
    
    <label style="font-size: 14px; font-weight: bold; color: #333;">ğŸ“ å®æ—¶è®¿è°ˆè®°å½• (å¯æ‰‹åŠ¨ä¿®æ”¹è¡¥å……):</label>
    <textarea id="transcript" rows="6" placeholder="å½“ä½ å¼€å§‹è¯´è¯æ—¶ï¼Œæ–‡å­—ä¼šå®æ—¶æ˜¾ç¤ºåœ¨è¿™é‡Œ..."></textarea>
  </div>

  <div class="card" id="reportCard" style="display: none;">
    <h3 style="margin-top: 0;">ğŸ“‘ AI ç»“æ„åŒ–æŠ¥å‘Š</h3>
    <div id="result"></div>
  </div>

  <script>
    // 1. åˆå§‹åŒ– API Key
    const apiKeyInput = document.getElementById('apiKey');
    apiKeyInput.value = localStorage.getItem('zhipu_api_key') || '';
    apiKeyInput.addEventListener('input', function() {
      localStorage.setItem('zhipu_api_key', this.value);
    });

    // 2. åˆå§‹åŒ–æµè§ˆå™¨è¯­éŸ³è¯†åˆ« API
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;
    let isRecording = false;

    const startBtn = document.getElementById('startBtn');
    const stopBtn = document.getElementById('stopBtn');
    const statusDiv = document.getElementById('status');
    const transcriptArea = document.getElementById('transcript');
    const reportCard = document.getElementById('reportCard');
    const resultDiv = document.getElementById('result');
    const langSelect = document.getElementById('langSelect');

    if (!SpeechRecognition) {
      statusDiv.innerHTML = "âŒ ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒåŸç”Ÿè¯­éŸ³è¯†åˆ«ï¼Œè¯·ä½¿ç”¨æœ€æ–°ç‰ˆ Chrome æˆ– Edge æµè§ˆå™¨ã€‚";
      startBtn.disabled = true;
    } else {
      recognition = new SpeechRecognition();
      recognition.continuous = true; 
      recognition.interimResults = true; 

      // å¼•æ“é™éŸ³è‡ªåŠ¨åœæ­¢æ—¶ï¼Œå¦‚æœæˆ‘ä»¬è¿˜åœ¨è®¿è°ˆçŠ¶æ€ï¼Œå°±è‡ªåŠ¨é‡å¯å®ƒ
      recognition.onend = () => {
        if (isRecording) {
          try {
            recognition.start();
          } catch(e) { /* å¿½ç•¥é‡å¤å¯åŠ¨é”™è¯¯ */ }
        }
      };

      recognition.onresult = (event) => {
        let interimTranscript = '';
        let finalTranscript = '';

        for (let i = event.resultIndex; i < event.results.length; ++i) {
          if (event.results[i].isFinal) {
            finalTranscript += event.results[i][0].transcript;
          } else {
            interimTranscript += event.results[i][0].transcript;
          }
        }
        
        if (finalTranscript) {
           transcriptArea.value += finalTranscript + "ã€‚";
        }
        statusDiv.innerHTML = `<span class="pulse">ğŸ”´ æ­£åœ¨è†å¬...</span> ` + interimTranscript;
      };
    }

    // 3. ç‚¹å‡»å¼€å§‹è®¿è°ˆ
    startBtn.onclick = () => {
      if (!apiKeyInput.value.trim()) {
        alert("è¯·å…ˆå¡«å†™é¡¶éƒ¨çš„ API Keyï¼");
        return;
      }

      // ã€æ ¸å¿ƒæŠ€èƒ½åŸ¹è®­ã€‘ï¼šåœ¨æ¯æ¬¡å¯åŠ¨å½•éŸ³å‰ï¼Œè¯»å–ä¸‹æ‹‰æ¡†çš„å€¼ï¼Œèµ‹å€¼ç»™è¯­éŸ³å¼•æ“
      recognition.lang = langSelect.value;
      console.log("å½“å‰è¯†åˆ«è¯­è¨€å·²è®¾ç½®ä¸º: " + recognition.lang);

      transcriptArea.value = ''; 
      reportCard.style.display = 'none';
      
      try {
        recognition.start();
        isRecording = true;
        startBtn.style.display = 'none';
        stopBtn.style.display = 'block';
        statusDiv.innerHTML = `<span class="pulse">ğŸ”´ æ­£åœ¨è†å¬ (${langSelect.options[langSelect.selectedIndex].text})...</span>`;
        langSelect.disabled = true; // å½•éŸ³æœŸé—´ç¦æ­¢åˆ‡æ¢è¯­è¨€
      } catch (e) {
        console.error("å¯åŠ¨å½•éŸ³å¤±è´¥", e);
      }
    };

    // 4. ç‚¹å‡»ç»“æŸè®¿è°ˆï¼Œå¹¶è§¦å‘å¤§æ¨¡å‹åˆ†æ
    stopBtn.onclick = async () => {
      isRecording = false;
      recognition.stop();
      
      startBtn.style.display = 'block';
      stopBtn.style.display = 'none';
      langSelect.disabled = false; // ç»“æŸå½•éŸ³åå…è®¸åˆ‡æ¢è¯­è¨€
      
      const textToProcess = transcriptArea.value.trim();
      if (!textToProcess) {
        statusDiv.innerText = "âš ï¸ æ²¡æœ‰å½•å…¥ä»»ä½•å†…å®¹ï¼Œåˆ†æå–æ¶ˆã€‚";
        return;
      }

      statusDiv.innerText = "â³ è®¿è°ˆç»“æŸã€‚å¤§æ¨¡å‹æ­£åœ¨æå–æ ¸å¿ƒä¿¡æ¯ï¼Œè¯·ç¨å€™...";
      reportCard.style.display = 'block';
      resultDiv.innerText = "åˆ†æä¸­...";

      await callLLM(textToProcess);
    };

    // 5. è°ƒç”¨å¤§æ¨¡å‹çš„æ ¸å¿ƒå‡½æ•°
    async function callLLM(text) {
      const apiKey = apiKeyInput.value.trim();
      try {
        const response = await fetch('https://open.bigmodel.cn/api/paas/v4/chat/completions', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${apiKey}`
          },
          body: JSON.stringify({
            model: "glm-4-flash",
            messages: [
              {
                role: "system",
                content: `ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„ç¤¾å·¥åŠ©æ‰‹ã€‚è¯·å°†ç”¨æˆ·æä¾›çš„åŸå§‹å£è¯­åŒ–è®¿è°ˆè®°å½•ï¼Œæç‚¼å¹¶åˆ†ç±»ä¸ºå››ä¸ªJSONå­—æ®µï¼š"å®¶åº­æƒ…å†µ", "èº«ä½“çŠ¶å†µ", "ç»æµçŠ¶å†µ", "å…¶ä»–æƒ…å†µ"ã€‚
è¦æ±‚ï¼š
1. æå–å®¢è§‚äº‹å®ï¼Œå»é™¤è¯­æ°”è¯å’Œé‡å¤çš„è¯è¯­ã€‚
2. å¦‚æœæŸé¡¹æœªæåŠè¯·å¡«"æ— è®°å½•"ã€‚
3. å¿…é¡»ä¸¥æ ¼è¾“å‡ºJSONæ ¼å¼ï¼Œä¸è¦ä»»ä½• Markdown æ ‡è®°æˆ–å¤šä½™è§£é‡Šã€‚`
              },
              { role: "user", content: text }
            ],
            temperature: 0.1
          })
        });

        const data = await response.json();
        if (response.ok) {
           let aiReply = data.choices[0].message.content;
           aiReply = aiReply.replace(/```json/g, '').replace(/```/g, '').trim();
           resultDiv.innerText = aiReply;
           statusDiv.innerText = "âœ… æŠ¥å‘Šç”Ÿæˆå®Œæ¯•ï¼ä½ å¯ä»¥å¤åˆ¶ä¸‹æ–¹ç»“æœã€‚";
        } else {
           resultDiv.innerText = "é”™è¯¯è¯¦æƒ…:\n" + JSON.stringify(data.error, null, 2);
           statusDiv.innerText = "âŒ åˆ†æå¤±è´¥ã€‚";
        }
      } catch (error) {
        resultDiv.innerText = "ç½‘ç»œå¼‚å¸¸ï¼š" + error.message;
        statusDiv.innerText = "âŒ è¯·æ±‚å¤§æ¨¡å‹è¶…æ—¶æˆ–å¤±è´¥ã€‚";
      }
    }
  </script>

</body>
</html>